{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load ui_extras %}
{% load static %}
{% block title %}
    {{ collection }}
{% endblock %}

{% block content_header %}
<div class="row">
  <div class="col-md-12">
      <ol class="breadcrumb">
          <li><a href={% url "collection_set_list" %}>Collection Sets</a></li>
          <li><a href={% url "collection_set_detail" collection.collection_set.pk %}>{{ collection.collection_set.name }}</a></li>
	  <li class="active">{{ collection.name }}</a></li>
      </ol>
  </div>
</div>
<div class="row">
    <div class="col-md-10">
        <div class="panel {% if collection.is_active %} panel-on {% else %} panel-default panel-off {% endif %}">
            <div class="panel-heading" >
                <h1 class="panel-title">{{ collection.name }}</h1>
            </div>
            <div class="panel-body {% if collection.is_active %} panel-on {% else %} panel-off {% endif %}">
                <div class="col-md-1">
                    <img src={% static "ui/img/"|add:collection.credential.platform|add:"_logo.png" %} height=60 width=60/>
                </div>
                <div class="col-md-9">
                    <h3>{{ collection.get_harvest_type_display }}</h3>
                    {% if collection.is_active %}<p>Collection is active. Turn off to edit.</p>{% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <form method="post" action={% url "collection_toggle_active" collection.pk %}>
            {% csrf_token %}
            {% if collection.is_active %}
                <button type="submit" class="btn btn-danger">
                    <span class="glyphicon glyphicon-off" aria-hidden="true"></span> Turn off
                </button><br />
            {% else %}
            <button type="submit" class={% if seed_error_message or seed_warning_message %}"btn btn-default" disabled="disabled" {% else %} "btn btn-success" {% endif %}>
                <span class="glyphicon glyphicon-off" aria-hidden="true"></span> Turn on
            </button><br />
        {% endif %}
        </form>
        <a type="button" class="btn btn-primary btn-stacked" href={% url "collection_update" collection.pk %}  {% if collection.is_active %}disabled="disabled"{% endif %} >
            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Edit
        </a>
        <a type="button" class="btn btn-primary btn-stacked" {% if not can_export %} disabled {% endif %} href="{% url "export_create" collection.id %}">
            <span class="glyphicon glyphicon-export" aria-hidden="true"></span> Export
        </a>
    </div>
</div>
{% endblock %}
{% block content %}
{% if next_run_time %}
    <div class="alert alert-info" role="alert">Next harvest at {{ next_run_time }}</div>
{% endif %}
{% if seed_warning_message %}
    <div class="alert alert-warning" role="alert">{{ seed_warning_message }}</div>
{% endif %}
{% if seed_error_message %}
    <div class="alert alert-danger" role="alert">{{ seed_error_message }}</div>
{% endif %}
{% if not seed_error_message and not seed_warning_message and not collection.is_active %}
    <div class="alert alert-warning" role="alert">Turn on collection to start harvesting.</div>
{% endif %}
<div class="row subsection">
    <div class="col-md-8">
        {% if collection.description %}
            <p>{{ collection.description }}</p>
        {% endif %}
        <p><strong>Credential: </strong> <a href={% url "credential_detail" collection.credential.pk %}>{{ collection.credential.name }}</a></p>
        {{ collection.harvest_options|json }}
        {% if collection.schedule_minutes %}
            <p><strong>Schedule:</strong> {{ collection.get_schedule_minutes_display }}</p>
        {% endif %}
        <p><strong>End date: </strong> {{ collection.end_date }}</p>
        {% if collection.stats %}
            <p><strong>Stats:</strong><ul>
                {% for item, count in collection.stats.items %}
                    <li>{{item}}: {{count}}</li>
                {% endfor %}
            </ul></p>
        {% endif %}
    </div>
    <div class="col-md-4">
        <div class="panel panel-default">
            <div class="panel-body">
                <p><strong>Id:</strong> {{ collection.collection_id }}</p>
                <p><strong>Created:</strong> {{ collection.date_added }}</p>
            </div>
        </div>
    </div>
</div>
{% if has_seeds_list %}
<div class="row subsection">
    <div class="panel panel-default">
        <div class="panel-heading"><h4>Seeds</h4></div>
        <div class="panel-body">
            <table class="table">
                <thead>
                <tr>
                    <th>Token</th>
                    <th>Uid</th>
                    <th>Active</th>
                </tr>
                </thead>
                {% for seed in seed_list %}
                <tr>
                    <td><a href="{% url "seed_detail" seed.pk %}">{{ seed.token|json_list }}</a></td>
                    <td>{{ seed.uid }}</td>
                    <td>{{ seed.is_active|yesno:"Yes,No" }}</td>
				</tr>
				{% endfor %}
            </table>
            <a class="btn btn-primary" value="Add Seed" href="{% url "seed_create" collection.id %}" {% if collection.is_active %}disabled="disabled"{% endif %} >Add Seed</a>
            {% if can_add_bulk_seeds %}
                <a class="btn btn-primary" value="Bulk Add Seed" href="{% url "bulk_seed_create" collection.id %}" {% if collection.is_active %}disabled="disabled"{% endif %} >Bulk Add Seeds</a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% if harvests %}
<div class="row">
    <div class="panel panel-default">
        <div class="panel-heading"><h4>Harvests</h4> (1-{{ harvests|length }} of {{ harvest_count }})</div>
        <div class="panel-body">
            <table class="table">
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Date requested</th>
                    <th>Status</th>
                    <th>Messages</th>
                </tr>
                </thead>
                {% for harvest in harvests %}
                <tr>
                    <td><a href="{% url "harvest_detail" harvest.pk %}">{{ harvest.get_harvest_type_display }}</a></td>
                    <td>{{ harvest.date_requested }}</td>
                    <td>{{ harvest.get_status_display }}</td>
                    <td>{{ harvest.message_count }} message{{harvest.message_count|pluralize}}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% if harvest_count > harvests|length %}
        <div class="panel-footer"><a href="{% url "collection_harvests" collection.pk %}">View all {{ harvest_count }} harvests</a></div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <h4>Change log</h4>
        {% include "ui/diff_snippet.html" with log_entries=collection.log_entries %}
    </div>
</div>
{% endblock %}
